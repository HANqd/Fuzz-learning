# Skyfire
<p>2017 S&P </br>

  [paper](https://www.ieee-security.org/TC/SP2017/papers/42.pdf)</p>


### 思路
<p>本文中提出了一种新的数据驱动的种子生成方法，名为Skyfire，将大量现有的样本和语法作为输入，通过PCSG（概率上下文敏感语法）的学习，为处理高度结构化输入的模糊程序生成覆盖良好的种子。</p>
<p>测试高度结构化的输入，基于生成的。</p>
<p>它利用大量样本（即语料库）自动提取语法和语义规则的知识，并利用这些知识为处理高度结构化输入的程序生成均匀分布的种子输入。</p>

### 具体步骤
<ul><li>1.种子生成：第一步将语料库和语法作为输入，分两步生成种子：  
  (1)将基于语法的语料库解析为抽象语法树，并学习概率上下文敏感语法（PCSG），他指定语法特征和语义规则。与基于生成的模糊测试中广泛使用的无上下文语法不通，PCSG中的每个生成规则与可以应用生成规则的上下文以及在上下文中应用生成规则的概率相关联。 
  
(2)Skyfire通过在非终端符号上迭代地选择和应用满足上下文的生产规则来生成种子，直到在结果字符串中没有非终端符号。</li>
<li>2.种子选择：以代码覆盖率为种子的选择标准，减少种子冗余。</li>
<li>3.种子突变：Skyfire通过使用基于生产规则的相同类型的节点随机替换AST中的叶级节点来改变剩余的种子输入，这在保持语法结构的同时以多种方式引入语义变化。</li></ul>

### 效果
<p>将收集的样本和Skyfire生成的输入作为AFL的种子，模糊几个开源XSLT和XML引擎，结果表明，Skyfire可以生成均匀分布的种子，显著提高了代码覆盖率（路径覆盖率为20%，函数覆盖率为15%）和漏洞发现能力。还模糊了闭源JavaScript和Internet Explorer11 的渲染引擎，发现了16个新的漏洞。</p>

# Profuzzer
<p>2019 S&P </br>

  [paper](https://wcventure.github.io/FuzzingPaper/Paper/SP19_Profuzz.pdf) </p>

### 为什么会提出

1. 基于生成的方法产生的输入尽管语法结构合理，确实减少了搜索空间，但它几乎没有提供各种输入可能对程序执行产生影响的线索：例如，一组输入是否都将导致相同的执行路径，因此仅其中之一应进行测试。此外，利用漏洞的输入甚至可能不遵循输入语法，因为如果某些输入字段与功能无关，则实现可能会选择忽略某些输入字段（例如，图像格式转换器可能忽略与渲染相关的字段）；也有错误的实现，甚至可能接受格式错误的输入。</br>

2. 基于变异的方法不需要关于输入模型的知识。相反，它使用一组合法的输入实例作为种子，并不断对其进行修改以探索各种执行路径。先前的研究已经研究了选择可能导致执行程序进入易受攻击的程序位置的正确种子的方法，以及确定可能增强代码覆盖率的关键输入字节的方法[9]，[10]。但是，对于给定的种子，变异通常是随机的，即使输入数据大小适中，变异也不会扩展。</br>

3. 就像我们在这里看到的那样，高效和可扩展的模糊测试过程的关键是深入了解目标程序的输入。这样的输入通常是结构化数据，并且可以划分为具有特定语义的一系列数据字段：例如，缓冲区大小，类别指示符等。这些字段的语义对于发现漏洞非常有用，有助于模糊测试人员确定要更改的字段，合法值的范围，数据字段对程序执行的影响等。利用这些信息，模糊器可以更智能的方式操作，仅关注最有可能导致执行路径从未见过的输入的子空间。但是，此信息（字段及其语义）可能没有记录，也无法提供给模糊测试器，并且如果不进行深入的重量级分析过程，可能很难恢复。</br>

4. 由此提出Profuzzer：</br>
我们提出了一种称为ProFuzzer的新智能模糊技术，该技术通过称为“探测”的轻量级随机模糊过程自动发现输入字段及其语义，以指导种子突变的在线进化。这种探测完全背负于常规的模糊测试，并且可以即时执行。更具体地说，ProFuzzer通过使一组种子变异来对目标程序执行两阶段模糊测试。在第一阶段（即探测阶段），它按顺序逐字节进行探测，即每次更改一个字节，针对目标程序枚举其值，然后移至下一个字节。此顺序的模糊测试步骤还会收集有关不同字节值下目标的执行路径的信息。该信息会自动进行在线分析，以恢复数据字段（将相关字节链接在一起）并确定其字段类型：例如，可以将其突变特定内容导致相同异常路径的连续字节分组为一个字段。在我们的研究中，我们确定了6种字段类型，这些字段类型对内容影响程序执行的方式进行了建模，例如大小，循环数和枚举，这些字段仅具有几个有效值，可以正确解释输入中的后续内容。这些类型与应用程序无关，描述了模糊相关的语义。数据字段及其类型的发现为第二阶段的模糊测试提供了指导，在此阶段，ProFuzzer对每个字段进行突变以利用可能导致攻击的值（例如，大数据量可能会利用缓冲区溢出漏洞），并根据字段类型探索合法值，以获得更好的覆盖范围。

### 思路

<p>对基于突变方法的改进，加入了一个实时探测技术，对输入的测试用例（种子）逐字节进行探测，对于功能一样的字节（例如，边缘字节的特定内容突变后，导致相同的执行路径）被分为一组，组成同类型的字段。利用这些字段和字段类型的信息，引导后续的突变。这种方法将语义知识发现无缝透明地集成到模糊处理过程中，不仅提高了模糊处理的准确性，而且提高了其性能，而不会降低适用性。</br>
现有的基于变异的模糊器倾向于在不了解其底层语法和语义的情况下随机变异该程序的输入。在本文中，我们提出了一种新颖的实时探测技术（称为ProFuzzer），该技术可自动恢复并了解在模糊过程中对漏洞发现至关重要的输入字段，并智能地适应突变策略 以增加达到零日目标的机会。由于这种探测透明地搭载于常规的模糊测试，因此无需事先了解输入规范。在模糊测试期间，首先对各个字节进行突变，然后自动分析其模糊测试结果，以将相关内容链接在一起，并确定连接它们的字段的类型；这些字节按照特定于类型的策略进一步突变在一起，从而大大减少了搜索空间。</br>

__重要启发__

1. 对于模糊测试，不需要全面，特定于应用程序且语义丰富的输入规范。识别特殊类型的字段的更有用的信息对于模糊测试至关重要的。</br>
2. 可以通过直接观察模糊过程来理解输入，并可以发现其字段和数据类型，特别是输入内容的变异方式以及程序响应变异的执行路径变化。</br>

Profuzzer分为两个阶段：
<ul><li>第一阶段:通过逐字节突变，探测输入种子的字段和字段类型，尤其是在突变后，基于目标程序的行为变化（如执行路径的变化），Profuzzer能够识别输入字段是非常关键的。</li>
 <li>第二阶段:由第一阶段得出的字段和字段类型来指导在线输入突变，不同的字段类型有不同的优先级和不同的突变策略。同一类型的字节组成的字段一起突变，这里的字段是之前探测到能产生路径覆盖的字节组合，所以这里的突变会更有方向，在不增加成本的同时扩大路径覆盖率。</li></p>


### 具体步骤
由四个组件组成：探测引擎，变异引擎，执行引擎和报告引擎。</br>

__探测引擎__:探测引擎的任务是根据给定二进制文件的种子输入生成类型模板。对于每个种子输入，ProFuzzer将遍历所有字节。对于每个字节，它遍历所有可能的值（0x00至0xff）并收集相应的执行配置文件。然后，从这些配置文件中提取一些指标（例如，由突变引起的边缘覆盖率变化），并将其用作字节的特征。然后，ProFuzzer将具有相似功能的连续字节分组到一个字段中。最后，它基于其可能值的变化与观察到的特征的相应变化之间的关系来确定每个字段的类型（例如，幻数字段可以通过以下模式来表征：所有突变发生在原始值中种子输入导致输入无效，因此执行时间短）。</br>

__变异引擎__:变异引擎使用探测到的模板（即字段和字段类型）来指导后续的突变。给出了两个方面的指导，第一是以具有成本效益的方式扩大覆盖范围。例如，ProFuzzer可以避免模糊原始数据字段，并专注于确定随后数据解释的变异字段。这将使我们能够到达原本难以到达的代码区域。在第二方面，领域信息可用于指导漏洞利用的产生。例如，缓冲区大小字段是许多漏洞的根本原因。已知某些突变模式对于大小域至关重要。</br>

__执行引擎和报表引擎__:我们使用标准的AFL执行和报告引擎。每次探测引擎或变异引擎请求执行应用程序时，执行引擎都会派生一个新进程。执行期间，它将自动收集执行配置文件。报表引擎监视执行情况，尤其是崩溃或挂起。</br>
